name: Vertex MLOps Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  vertex-ml:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Build source package
      run: |
        tar -czf src.tar.gz src setup.py

    - name: Upload package to GCS
      run: |
        gsutil cp src.tar.gz gs://${{ secrets.GCS_BUCKET }}/code/src.tar.gz

    - name: Launch Vertex AI Training Job
      run: |
        gcloud ai custom-jobs create \
          --region=${{ secrets.VERTEX_REGION }} \
          --display-name="train-$(date +%s)" \
          --python-package-uris=gs://${{ secrets.GCS_BUCKET }}/code/src.tar.gz \
          --worker-pool-spec=machine-type=e2-standard-4,executor-image-uri=us-docker.pkg.dev/vertex-ai/training/tf-cpu.2-11:latest,python-module=src.train_lstm \
          --args="--data_prefix=gs://${{ secrets.GCS_BUCKET }}/ohlcv-data" \
                "--pair=BTC_USDT"

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Visualize Model Using GCS Data
      run: |
        python3 src/visualize_model.py \
          --bucket ${{ secrets.GCS_BUCKET }} \
          --gcs_path ohlcv-data \
          --lookback 30

    - name: Upload Evaluation Plots
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-plots
        path: evaluation/plots*
