name: Evaluate Only

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "RUN_ID du modèle à évaluer"
        required: true

jobs:
  evaluate-only:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Auth Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Install dependencies
      run: pip install -r requirements.txt


    # 1) Télécharger dataset RAW
    - name: Prepare dataset
      run: |
        RUN_ID="${{ github.event.inputs.run_id }}"
        echo "Evaluating RUN_ID=$RUN_ID"

        mkdir -p data
        mkdir -p data/prepared

        echo "Downloading RAW parquet..."
        gsutil cp gs://${{ secrets.GCS_BUCKET }}/ohlcv-data/BTC_USDT_raw_${RUN_ID}.parquet data/raw.parquet

        echo "Converting parquet -> CSV..."
        python3 <<EOF
        import pandas as pd
        df = pd.read_parquet("data/raw.parquet")
        df.to_csv("data/raw.csv", index=False)
        EOF

        echo "Running prepare.py..."
        python3 src/prepare.py data/raw.csv data/prepared


    # 2) Télécharger modèle
    - name: Download model
      run: |
        RUN_ID="${{ github.event.inputs.run_id }}"
        echo "Downloading model for RUN_ID=$RUN_ID"

        MODEL_DIR="local_model_${RUN_ID}"
        mkdir -p $MODEL_DIR

        echo "Searching model folder in GCS..."
        MODEL_PATH=$(gsutil ls gs://${{ secrets.GCS_BUCKET }}/ohlcv-data/models/ | grep "BTC_USDT_${RUN_ID}_")

        if [ -z "$MODEL_PATH" ]; then
          echo "❌ Model folder not found for RUN_ID=$RUN_ID"
          exit 1
        fi

        # Remove trailing slashes
        MODEL_PATH=$(echo "$MODEL_PATH" | sed 's:/*$::')
        echo "Found model path: $MODEL_PATH"

        echo "Downloading model content..."
        # IMPORTANT FIX: copy ONLY the folder content, not the folder itself
        gsutil cp -r "$MODEL_PATH"/* "$MODEL_DIR/"


    # DEBUG — afficher ce que GitHub a téléchargé
    - name: Debug model folder
      run: |
        RUN_ID="${{ github.event.inputs.run_id }}"
        echo "Listing downloaded model folder:"
        ls -R "local_model_${RUN_ID}"


    # 3) Évaluer le modèle
    - name: Evaluate
      run: |
        RUN_ID="${{ github.event.inputs.run_id }}"
        echo "Running evaluate.py..."
        python3 src/evaluate.py "local_model_${RUN_ID}" data/prepared


    # 4) Visualiser
    - name: Visualize
      run: |
        RUN_ID="${{ github.event.inputs.run_id }}"
        echo "Running visualize_model.py..."
        python3 src/visualize_model.py \
          --bucket ${{ secrets.GCS_BUCKET }} \
          --gcs_path ohlcv-data \
          --lookback 30 \
          --run_id "$RUN_ID"


    # 5) Upload résultats
    - name: Upload evaluation plots
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-plots
        path: evaluation/
